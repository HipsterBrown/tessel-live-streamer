<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Tessel Live Cam</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      .widget {
        border: 3px solid red;
        float: left;
        margin-left: 2rem;
        width: 20%;
        max-height: 500px;
        overflow-y: scroll;
      }
    </style>
  </head>
  <body style="font-family:Helvetica,sans-serif;text-align:center;">
    <h1>My Home Dashboard</h1>
    <img src="/stream" alt="Tessel live stream" style="height:80%;width:70%;">
    <div class="widget">
      <h3>Weather Service</h3>
      <button id="getWeather">What's the weather?</button>
      <ul id="weatherList">
        <li><p>
            At 7:00 PM, the temperature was 75 degrees with a barometric pressure of 29.
        </p></li>
      </ul>
    </div>
    <footer style="padding:0 2rem;text-align:right;">
      <p style="color:red;">Powered by Tessel 2!</p>
    </footer>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
      var socket = io();
      var getWeather = document.getElementById('getWeather');
      var weatherList = document.getElementById('weatherList');

      function removeChildren(element) {
        if (element.hasChildNodes()) {
          Array.prototype.forEach.call(
            element.children,
            function(child) { child.remove() }
          );
        }
      }

      getWeather.addEventListener('click', function(event) {
        var loading = document.createElement('p');
        loading.appendChild(document.createTextNode("Loading..."));

        removeChildren(weatherList);
        weatherList.appendChild(loading);

        socket.emit('weather');
      });

      socket.on('response', function(data) {
        var list = document.createDocumentFragment();
        data.forEach(function(content) {
          var date = new Date(parseInt(content.id));
          var temp = content.doc.temperature;
          var pressure = content.doc.pressure;

          var item = document.createElement('li');
          var text = document.createTextNode("At " + date.getHours() + ":" + date.getMinutes() + ", the temperate was " + temp + " degrees with a barometric pressure of " + pressure + ".");

          item.appendChild(text);
          list.appendChild(item);
        });

        removeChildren(weatherList);
        weatherList.appendChild(list);
      });
    </script>
  </body>
</html>
